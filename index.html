<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="stylesheet" href="css/leaflet.css">
    <link rel="stylesheet" href="css/L.Control.Layers.Tree.css">
    <link rel="stylesheet" href="css/L.Control.Locate.min.css">
    <link rel="stylesheet" href="css/qgis2web.css">
    <link rel="stylesheet" href="css/fontawesome-all.min.css">
    <link rel="stylesheet" href="css/leaflet.photon.css">
    <link rel="stylesheet" href="css/leaflet-measure.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        html,
        body,
        #map {
            width: 100%;
            height: 100%;
            padding: 0;
            margin: 0;
            font-family: 'Outfit', sans-serif;
            background: #0f172a;
        }

        #map {
            position: absolute;
            left: 320px;
            width: calc(100% - 320px);
            height: 100vh;
            z-index: 1;
        }

        .sidebar {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 320px;
            background: #0f172a;
            color: white;
            padding: 24px;
            z-index: 1000;
            box-shadow: 4px 0 15px rgba(0, 0, 0, 0.5);
            overflow-y: auto;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar h1 {
            font-size: 22px;
            margin-top: 0;
            color: #38bdf8;
            font-weight: 600;
        }

        .sidebar p {
            font-size: 13px;
            opacity: 0.8;
            line-height: 1.5;
            margin-bottom: 25px;
        }

        .kpi-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin: 20px 0;
        }

        .kpi-card {
            background: rgba(30, 41, 59, 0.5);
            padding: 15px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            text-align: center;
        }

        .kpi-val {
            display: block;
            font-size: 20px;
            font-weight: 600;
            color: #fff;
        }

        .kpi-label {
            font-size: 11px;
            text-transform: uppercase;
            color: #94a3b8;
            letter-spacing: 0.5px;
        }

        .filter-section {
            margin-top: 30px;
        }

        .filter-section h3 {
            font-size: 14px;
            margin-bottom: 8px;
            color: #e2e8f0;
            font-weight: 600;
        }

        select {
            width: 100%;
            padding: 10px;
            background: #1e293b;
            border: 1px solid #334155;
            color: white;
            border-radius: 8px;
            margin-bottom: 15px;
            cursor: pointer;
            font-family: inherit;
        }

        /* Custom Popup Style */
        .leaflet-popup-content-wrapper {
            background: #1e293b !important;
            color: white !important;
            border-radius: 12px !important;
            padding: 0 !important;
            overflow: hidden;
        }

        .leaflet-popup-content {
            margin: 0 !important;
            width: 280px !important;
        }

        .leaflet-popup-tip {
            background: #1e293b !important;
        }

        .popup-header {
            padding: 12px;
            font-weight: 600;
            font-size: 14px;
            text-align: center;
        }

        .popup-header.finalizado {
            background: #10b981;
        }

        .popup-header.en-ejecucion {
            background: #f59e0b;
        }

        .popup-header.pendiente {
            background: #ef4444;
        }

        .popup-header.auditado {
            background: #059669;
        }

        .popup-body {
            padding: 15px;
        }

        .popup-body img {
            width: 100%;
            height: 120px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .popup-stat {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            font-size: 12px;
        }

        .popup-stat-label {
            color: #94a3b8;
        }

        .progress-bar {
            height: 6px;
            background: #334155;
            border-radius: 3px;
            margin: 8px 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: #38bdf8;
        }

        /* Modern Leaflet Controls */
        .leaflet-control-layers-tree {
            background: rgba(15, 23, 42, 0.9) !important;
            color: white !important;
            border: none !important;
            border-radius: 8px !important;
            padding: 10px !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3) !important;
        }
    </style>
    <title></title>
</head>

<body>
    <div class="sidebar">
        <h1>Gesti√≥n Proyectos 8%</h1>
        <p>Monitoreo Territorial de Fondos de Seguridad P√∫blica - Demo Especialista</p>

        <div class="kpi-container">
            <div class="kpi-card">
                <span class="kpi-val" id="kpi-total-proyectos">8</span>
                <span class="kpi-label">Proyectos</span>
            </div>
            <div class="kpi-card">
                <span class="kpi-val" id="kpi-inversion-total">$68.4M</span>
                <span class="kpi-label">Inversi√≥n</span>
            </div>
            <div class="kpi-card">
                <span class="kpi-val" id="kpi-beneficiarios">2,790</span>
                <span class="kpi-label">Beneficiarios</span>
            </div>
            <div class="kpi-card">
                <span class="kpi-val" id="kpi-avance">62%</span>
                <span class="kpi-label">Avance Prom.</span>
            </div>
        </div>

        <div class="filter-section">
            <h3>Filtrar por Tipo de Intervenci√≥n</h3>
            <select id="filter-tipo" onchange="filterLayers()">
                <option value="all">Todos los Tipos</option>
                <option value="Alarmas Comunitarias">Alarmas Comunitarias</option>
                <option value="C√°maras de Vigilancia">C√°maras de Vigilancia</option>
                <option value="Luminarias LED">Luminarias LED</option>
                <option value="Cierre Perimetral">Cierre Perimetral</option>
            </select>

            <h3>Estado de Ejecuci√≥n</h3>
            <select id="filter-estado" onchange="filterLayers()">
                <option value="all">Todos los Estados</option>
                <option value="Pendiente">Pendiente</option>
                <option value="En Ejecuci√≥n">En Ejecuci√≥n</option>
                <option value="Finalizado">Finalizado</option>
                <option value="Auditado">Auditado</option>
            </select>
        </div>

        <div
            style="margin-top: 30px; padding: 15px; background: rgba(56, 189, 248, 0.1); border-radius: 8px; border-left: 4px solid #38bdf8;">
            <h4 style="margin: 0 0 5px 0; font-size: 14px; color: #38bdf8;">KPI Territorial</h4>
            <p style="font-size: 11px; margin: 0; color: #94a3b8;">La inversi√≥n actual cubre el <b>24%</b> de los puntos
                calientes de delitos identificados en 2024.</p>
        </div>

        <div class="chart-section" style="margin-top: 30px; height: 250px; position: relative;">
            <h3 style="font-size: 14px; color: #e2e8f0; margin-bottom: 10px;">Inversi√≥n por Tipo</h3>
            <canvas id="chart-tipo"></canvas>
        </div>

        <div class="chart-section" style="margin-top: 30px; margin-bottom: 30px; height: 180px; position: relative;">
            <h3 style="font-size: 14px; color: #e2e8f0; margin-bottom: 10px;">Proyectos por Estado</h3>
            <canvas id="chart-estado"></canvas>
        </div>
    </div>
    <div id="map">
    </div>
    <script src="js/qgis2web_expressions.js"></script>
    <script src="js/leaflet.js"></script>
    <script src="js/leaflet-heat.js"></script>
    <script src="js/L.Control.Layers.Tree.min.js"></script>
    <script src="js/L.Control.Locate.min.js"></script>
    <script src="js/leaflet.rotatedMarker.js"></script>
    <script src="js/leaflet.pattern.js"></script>
    <script src="js/leaflet-hash.js"></script>
    <script src="js/Autolinker.min.js"></script>
    <script src="js/rbush.min.js"></script>
    <script src="js/labelgun.min.js"></script>
    <script src="js/labels.js"></script>
    <script src="js/leaflet.photon.js"></script>
    <script src="js/leaflet-measure.js"></script>
    <script src="data/Limite_urb_2.js"></script>
    <script src="data/CoberturadeCamarasdeVigilancia_3.js"></script>
    <script src="data/Sedes_comunitarias_4.js"></script>
    <script src="data/Delitos_2024_5.js"></script>
    <script src="data/Areasverdes_6.js"></script>
    <script src="data/Luminarias_7.js"></script>
    <script>
        var map = L.map('map', {
            zoomControl: false, maxZoom: 28, minZoom: 1
        }).fitBounds([[-36.64463191405659, -72.1719289227314], [-36.60646974446404, -72.08702260265204]]);
        var hash = new L.Hash(map);
        map.attributionControl.setPrefix('<a href="https://github.com/tomchadwin/qgis2web" target="_blank">qgis2web</a> &middot; <a href="https://leafletjs.com" title="A JS library for interactive maps">Leaflet</a> &middot; <a href="https://qgis.org">QGIS</a>');
        var autolinker = new Autolinker({ truncate: { length: 30, location: 'smart' } });
        // remove popup's row if "visible-with-data"
        function removeEmptyRowsFromPopupContent(content, feature) {
            var tempDiv = document.createElement('div');
            tempDiv.innerHTML = content;
            var rows = tempDiv.querySelectorAll('tr');
            for (var i = 0; i < rows.length; i++) {
                var td = rows[i].querySelector('td.visible-with-data');
                var key = td ? td.id : '';
                if (td && td.classList.contains('visible-with-data') && feature.properties[key] == null) {
                    rows[i].parentNode.removeChild(rows[i]);
                }
            }
            return tempDiv.innerHTML;
        }
        // modify popup if contains media
        function addClassToPopupIfMedia(content, popup) {
            var tempDiv = document.createElement('div');
            tempDiv.innerHTML = content;
            var imgTd = tempDiv.querySelector('td img');
            if (imgTd) {
                var src = imgTd.getAttribute('src');
                if (/\.(jpg|jpeg|png|gif|bmp|webp|avif)$/i.test(src)) {
                    popup._contentNode.classList.add('media');
                    setTimeout(function () {
                        popup.update();
                    }, 10);
                } else if (/\.(mp3|wav|ogg|aac)$/i.test(src)) {
                    var audio = document.createElement('audio');
                    audio.controls = true;
                    audio.src = src;
                    imgTd.parentNode.replaceChild(audio, imgTd);
                    popup._contentNode.classList.add('media');
                    setTimeout(function () {
                        popup.setContent(tempDiv.innerHTML);
                        popup.update();
                    }, 10);
                } else if (/\.(mp4|webm|ogg|mov)$/i.test(src)) {
                    var video = document.createElement('video');
                    video.controls = true;
                    video.src = src;
                    video.style.width = "400px";
                    video.style.height = "300px";
                    video.style.maxHeight = "60vh";
                    video.style.maxWidth = "60vw";
                    imgTd.parentNode.replaceChild(video, imgTd);
                    popup._contentNode.classList.add('media');
                    // Aggiorna il popup quando il video carica i metadati
                    video.addEventListener('loadedmetadata', function () {
                        popup.update();
                    });
                    setTimeout(function () {
                        popup.setContent(tempDiv.innerHTML);
                        popup.update();
                    }, 10);
                } else {
                    popup._contentNode.classList.remove('media');
                }
            } else {
                popup._contentNode.classList.remove('media');
            }
        }
        var zoomControl = L.control.zoom({
            position: 'topleft'
        }).addTo(map);
        L.control.locate({ locateOptions: { maxZoom: 19 } }).addTo(map);
        var measureControl = new L.Control.Measure({
            position: 'topleft',
            primaryLengthUnit: 'meters',
            secondaryLengthUnit: 'kilometers',
            primaryAreaUnit: 'sqmeters',
            secondaryAreaUnit: 'hectares'
        });
        measureControl.addTo(map);
        document.getElementsByClassName('leaflet-control-measure-toggle')[0].innerHTML = '';
        document.getElementsByClassName('leaflet-control-measure-toggle')[0].className += ' fas fa-ruler';
        var bounds_group = new L.featureGroup([]);
        function setBounds() {
        }
        map.createPane('pane_OpenStreetMap_0');
        map.getPane('pane_OpenStreetMap_0').style.zIndex = 400;
        var layer_OpenStreetMap_0 = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            pane: 'pane_OpenStreetMap_0',
            opacity: 1.0,
            attribution: '',
            minZoom: 1,
            maxZoom: 28,
            minNativeZoom: 0,
            maxNativeZoom: 19
        });
        layer_OpenStreetMap_0;
        map.createPane('pane_Satelite_1');
        map.getPane('pane_Satelite_1').style.zIndex = 401;
        var layer_Satelite_1 = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            pane: 'pane_Satelite_1',
            opacity: 0.741,
            attribution: '',
            minZoom: 1,
            maxZoom: 28,
            minNativeZoom: 0,
            maxNativeZoom: 18
        });
        layer_Satelite_1;
        map.addLayer(layer_Satelite_1);
        function pop_Limite_urb_2(feature, layer) {
            var popupContent = '<table>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['Name'] !== null ? autolinker.link(String(feature.properties['Name']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['descriptio'] !== null ? autolinker.link(String(feature.properties['descriptio']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['timestamp'] !== null ? autolinker.link(String(feature.properties['timestamp']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['begin'] !== null ? autolinker.link(String(feature.properties['begin']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['end'] !== null ? autolinker.link(String(feature.properties['end']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['altitudeMo'] !== null ? autolinker.link(String(feature.properties['altitudeMo']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['tessellate'] !== null ? autolinker.link(String(feature.properties['tessellate']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['extrude'] !== null ? autolinker.link(String(feature.properties['extrude']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['visibility'] !== null ? autolinker.link(String(feature.properties['visibility']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['drawOrder'] !== null ? autolinker.link(String(feature.properties['drawOrder']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['icon'] !== null ? autolinker.link(String(feature.properties['icon']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                </table>';
            var content = removeEmptyRowsFromPopupContent(popupContent, feature);
            layer.on('popupopen', function (e) {
                addClassToPopupIfMedia(content, e.popup);
            });
            layer.bindPopup(content, { maxHeight: 400 });
        }

        function style_Limite_urb_2_0() {
            return {
                pane: 'pane_Limite_urb_2',
                opacity: 1,
                color: 'rgba(35,35,35,1.0)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 1.0,
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(231,113,72,0.0)',
                interactive: true,
            }
        }
        map.createPane('pane_Limite_urb_2');
        map.getPane('pane_Limite_urb_2').style.zIndex = 402;
        map.getPane('pane_Limite_urb_2').style['mix-blend-mode'] = 'normal';
        var layer_Limite_urb_2 = new L.geoJson(json_Limite_urb_2, {
            attribution: '',
            interactive: true,
            dataVar: 'json_Limite_urb_2',
            layerName: 'layer_Limite_urb_2',
            pane: 'pane_Limite_urb_2',
            onEachFeature: pop_Limite_urb_2,
            style: style_Limite_urb_2_0,
        });
        bounds_group.addLayer(layer_Limite_urb_2);
        map.addLayer(layer_Limite_urb_2);
        function pop_CoberturadeCamarasdeVigilancia_3(feature, layer) {
            var popupContent = '<table>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['id'] !== null ? autolinker.link(String(feature.properties['id']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['S INES C1'] !== null ? autolinker.link(String(feature.properties['S INES C1']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['id_2'] !== null ? autolinker.link(String(feature.properties['id_2']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                </table>';
            var content = removeEmptyRowsFromPopupContent(popupContent, feature);
            layer.on('popupopen', function (e) {
                addClassToPopupIfMedia(content, e.popup);
            });
            layer.bindPopup(content, { maxHeight: 400 });
        }

        function style_CoberturadeCamarasdeVigilancia_3_0() {
            return {
                pane: 'pane_CoberturadeCamarasdeVigilancia_3',
                opacity: 1,
                color: 'rgba(35,35,35,0.0)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 1.0,
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(42,232,242,0.5647058823529412)',
                interactive: false,
            }
        }
        map.createPane('pane_CoberturadeCamarasdeVigilancia_3');
        map.getPane('pane_CoberturadeCamarasdeVigilancia_3').style.zIndex = 403;
        map.getPane('pane_CoberturadeCamarasdeVigilancia_3').style['mix-blend-mode'] = 'normal';
        var layer_CoberturadeCamarasdeVigilancia_3 = new L.geoJson(json_CoberturadeCamarasdeVigilancia_3, {
            attribution: '',
            interactive: false,
            dataVar: 'json_CoberturadeCamarasdeVigilancia_3',
            layerName: 'layer_CoberturadeCamarasdeVigilancia_3',
            pane: 'pane_CoberturadeCamarasdeVigilancia_3',
            onEachFeature: pop_CoberturadeCamarasdeVigilancia_3,
            style: style_CoberturadeCamarasdeVigilancia_3_0,
        });
        bounds_group.addLayer(layer_CoberturadeCamarasdeVigilancia_3);
        map.addLayer(layer_CoberturadeCamarasdeVigilancia_3);
        function pop_Sedes_comunitarias_4(feature, layer) {
            var props = feature.properties;
            var estadoClass = (props.Estado || '').toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(' ', '-');

            var popupContent = `
                <div class="popup-header ${estadoClass}">
                    ${props.Organizacion}
                </div>
                <div class="popup-body">
                    <img src="${props.Foto || 'https://via.placeholder.com/280x120'}" alt="Respaldo">
                    <div class="popup-stat">
                        <span class="popup-stat-label">Tipo:</span>
                        <span><b>${props.Tipo}</b></span>
                    </div>
                    <div class="popup-stat">
                        <span class="popup-stat-label">Inversi√≥n:</span>
                        <span><b>$${((props.Monto || 0) / 1000000).toFixed(1)}M</b></span>
                    </div>
                    <div class="popup-stat">
                        <span class="popup-stat-label">Beneficiarios:</span>
                        <span><b>${props.Beneficiarios}</b></span>
                    </div>
                    <div class="popup-stat" style="margin-top: 10px;">
                        <span class="popup-stat-label">Avance F√≠sico:</span>
                        <span><b>${props.Ejecucion}%</b></span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${props.Ejecucion}%"></div>
                    </div>
                    <div class="popup-stat">
                        <span class="popup-stat-label">Estado:</span>
                        <span style="background:rgba(255,255,255,0.1); padding:2px 8px; border-radius:4px; font-size:10px;">${props.Estado}</span>
                    </div>
                </div>
            `;
            layer.bindPopup(popupContent, { maxWidth: 280, padding: 0 });
        }

        function style_Sedes_comunitarias_4_0(feature) {
            var color = '#ef4444'; // Pendiente
            if (feature.properties.Estado === 'Finalizado') color = '#10b981';
            if (feature.properties.Estado === 'Auditado') color = '#059669';
            if (feature.properties.Estado === 'En Ejecuci√≥n') color = '#f59e0b';

            return {
                pane: 'pane_Sedes_comunitarias_4',
                radius: 8.0,
                opacity: 1,
                color: 'white',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 2,
                fill: true,
                fillOpacity: 1,
                fillColor: color,
                interactive: true,
            }
        }
        map.createPane('pane_Sedes_comunitarias_4');
        map.getPane('pane_Sedes_comunitarias_4').style.zIndex = 404;
        map.getPane('pane_Sedes_comunitarias_4').style['mix-blend-mode'] = 'normal';
        var layer_Sedes_comunitarias_4 = new L.geoJson(json_Sedes_comunitarias_4, {
            attribution: '',
            interactive: true,
            dataVar: 'json_Sedes_comunitarias_4',
            layerName: 'layer_Sedes_comunitarias_4',
            pane: 'pane_Sedes_comunitarias_4',
            onEachFeature: pop_Sedes_comunitarias_4,
            pointToLayer: function (feature, latlng) {
                return L.circleMarker(latlng, style_Sedes_comunitarias_4_0(feature));
            },
        });
        bounds_group.addLayer(layer_Sedes_comunitarias_4);
        map.addLayer(layer_Sedes_comunitarias_4);

        function pop_Delitos_2024_5(feature, layer) {
            var popupContent = 'Delito: ' + feature.properties.layer;
            layer.bindPopup(popupContent);
        }

        function style_Delitos_2024_5_0() {
            return {
                radius: 1,
                opacity: 0,
                fillOpacity: 0,
                interactive: false,
            }
        }
        map.createPane('pane_Delitos_2024_5');
        map.getPane('pane_Delitos_2024_5').style.zIndex = 405;

        // Heatmap for Delitos
        var heat_data = json_Delitos_2024_5.features.map(function (f) {
            return [f.geometry.coordinates[1], f.geometry.coordinates[0], 0.8];
        });
        var layer_Delitos_Heat = L.heatLayer(heat_data, {
            radius: 20,
            blur: 15,
            maxZoom: 18,
            gradient: { 0.4: 'blue', 0.6: 'cyan', 0.7: 'lime', 0.8: 'yellow', 1: 'red' }
        });
        map.addLayer(layer_Delitos_Heat);

        var layer_Delitos_2024_5 = new L.geoJson(json_Delitos_2024_5, {
            attribution: '',
            interactive: false,
            dataVar: 'json_Delitos_2024_5',
            layerName: 'layer_Delitos_2024_5',
            pane: 'pane_Delitos_2024_5',
            onEachFeature: pop_Delitos_2024_5,
            pointToLayer: function (feature, latlng) {
                return L.circleMarker(latlng, style_Delitos_2024_5_0());
            },
        });
        bounds_group.addLayer(layer_Delitos_2024_5);

        function pop_Areasverdes_6(feature, layer) {
            var popupContent = '<table>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['fid'] !== null ? autolinker.link(String(feature.properties['fid']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['full_id'] !== null ? autolinker.link(String(feature.properties['full_id']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['osm_id'] !== null ? autolinker.link(String(feature.properties['osm_id']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['osm_type'] !== null ? autolinker.link(String(feature.properties['osm_type']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['leisure'] !== null ? autolinker.link(String(feature.properties['leisure']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['landuse'] !== null ? autolinker.link(String(feature.properties['landuse']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['addr:place'] !== null ? autolinker.link(String(feature.properties['addr:place']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['dog'] !== null ? autolinker.link(String(feature.properties['dog']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['addr:state'] !== null ? autolinker.link(String(feature.properties['addr:state']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['addr:district'] !== null ? autolinker.link(String(feature.properties['addr:district']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['object:housenumber'] !== null ? autolinker.link(String(feature.properties['object:housenumber']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['addr:postcode'] !== null ? autolinker.link(String(feature.properties['addr:postcode']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['addr:country'] !== null ? autolinker.link(String(feature.properties['addr:country']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['surface'] !== null ? autolinker.link(String(feature.properties['surface']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['sport'] !== null ? autolinker.link(String(feature.properties['sport']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['wheelchair'] !== null ? autolinker.link(String(feature.properties['wheelchair']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['addr:street'] !== null ? autolinker.link(String(feature.properties['addr:street']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['addr:housenumber'] !== null ? autolinker.link(String(feature.properties['addr:housenumber']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['access'] !== null ? autolinker.link(String(feature.properties['access']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['object:street'] !== null ? autolinker.link(String(feature.properties['object:street']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['wikipedia'] !== null ? autolinker.link(String(feature.properties['wikipedia']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['wikimedia_commons'] !== null ? autolinker.link(String(feature.properties['wikimedia_commons']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['wikidata'] !== null ? autolinker.link(String(feature.properties['wikidata']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['operator:type'] !== null ? autolinker.link(String(feature.properties['operator:type']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['operator'] !== null ? autolinker.link(String(feature.properties['operator']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['opening_hours'] !== null ? autolinker.link(String(feature.properties['opening_hours']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['addr:city'] !== null ? autolinker.link(String(feature.properties['addr:city']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['alt_name_2'] !== null ? autolinker.link(String(feature.properties['alt_name_2']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['alt_name_1'] !== null ? autolinker.link(String(feature.properties['alt_name_1']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['alt_name'] !== null ? autolinker.link(String(feature.properties['alt_name']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['description'] !== null ? autolinker.link(String(feature.properties['description']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['type'] !== null ? autolinker.link(String(feature.properties['type']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['name'] !== null ? autolinker.link(String(feature.properties['name']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['loc_name'] !== null ? autolinker.link(String(feature.properties['loc_name']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                </table>';
            var content = removeEmptyRowsFromPopupContent(popupContent, feature);
            layer.on('popupopen', function (e) {
                addClassToPopupIfMedia(content, e.popup);
            });
            layer.bindPopup(content, { maxHeight: 400 });
        }

        function style_Areasverdes_6_0() {
            return {
                pane: 'pane_Areasverdes_6',
                opacity: 1,
                color: 'rgba(35,35,35,0.0)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 1.0,
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(31,175,5,0.5098039215686274)',
                interactive: false,
            }
        }
        map.createPane('pane_Areasverdes_6');
        map.getPane('pane_Areasverdes_6').style.zIndex = 406;
        map.getPane('pane_Areasverdes_6').style['mix-blend-mode'] = 'normal';
        var layer_Areasverdes_6 = new L.geoJson(json_Areasverdes_6, {
            attribution: '',
            interactive: false,
            dataVar: 'json_Areasverdes_6',
            layerName: 'layer_Areasverdes_6',
            pane: 'pane_Areasverdes_6',
            onEachFeature: pop_Areasverdes_6,
            style: style_Areasverdes_6_0,
        });
        bounds_group.addLayer(layer_Areasverdes_6);
        map.addLayer(layer_Areasverdes_6);
        function pop_Luminarias_7(feature, layer) {
            var popupContent = '<table>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['Layer'] !== null ? autolinker.link(String(feature.properties['Layer']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['Medidor'] !== null ? autolinker.link(String(feature.properties['Medidor']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['Luminarias'] !== null ? autolinker.link(String(feature.properties['Luminarias']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['E_C_A_P'] !== null ? autolinker.link(String(feature.properties['E_C_A_P']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                </table>';
            var content = removeEmptyRowsFromPopupContent(popupContent, feature);
            layer.on('popupopen', function (e) {
                addClassToPopupIfMedia(content, e.popup);
            });
            layer.bindPopup(content, { maxHeight: 400 });
        }

        function style_Luminarias_7_0() {
            return {
                pane: 'pane_Luminarias_7',
                radius: 2.0000000000000004,
                opacity: 1,
                color: 'rgba(35,35,35,0.0)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 1,
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(255,255,51,1.0)',
                interactive: false,
            }
        }
        map.createPane('pane_Luminarias_7');
        map.getPane('pane_Luminarias_7').style.zIndex = 407;
        map.getPane('pane_Luminarias_7').style['mix-blend-mode'] = 'normal';
        var layer_Luminarias_7 = new L.geoJson(json_Luminarias_7, {
            attribution: '',
            interactive: false,
            dataVar: 'json_Luminarias_7',
            layerName: 'layer_Luminarias_7',
            pane: 'pane_Luminarias_7',
            onEachFeature: pop_Luminarias_7,
            pointToLayer: function (feature, latlng) {
                var context = {
                    feature: feature,
                    variables: {}
                };
                return L.circleMarker(latlng, style_Luminarias_7_0(feature));
            },
        });
        bounds_group.addLayer(layer_Luminarias_7);
        map.addLayer(layer_Luminarias_7);
        var overlaysTree = [
            {
                label: '<b>CAPAS DE MONITOREO</b>', children: [
                    { label: 'üè¢ Proyectos Fondo 8% Seguridad', layer: layer_Sedes_comunitarias_4 },
                    { label: 'üî• Mapa de Calor Delitos 2024', layer: layer_Delitos_Heat },
                ]
            },
            {
                label: '<b>INFRAESTRUCTURA</b>', children: [
                    { label: 'üí° Luminarias P√∫blicas (Red)', layer: layer_Luminarias_7 },
                    { label: 'üìπ Cobertura C√°maras Municipales', layer: layer_CoberturadeCamarasdeVigilancia_3 },
                ]
            },
            {
                label: '<b>URBANISMO</b>', children: [
                    { label: 'üå≥ √Åreas Verdes (Recuperaci√≥n)', layer: layer_Areasverdes_6 },
                    { label: 'üèôÔ∏è L√≠mite Urbano Oficial', layer: layer_Limite_urb_2 },
                ]
            },
            {
                label: '<b>MAPAS BASE</b>', children: [
                    { label: "üåè Imagen Satelital", layer: layer_Satelite_1 },
                    { label: "üó∫Ô∏è OpenStreetMap", layer: layer_OpenStreetMap_0 },
                ]
            }
        ]

        var lay = L.control.layers.tree(null, overlaysTree, {
            collapsed: false,
        });
        lay.addTo(map);

        // Filtering Logic
        function filterLayers() {
            var tipo = document.getElementById('filter-tipo').value;
            var estado = document.getElementById('filter-estado').value;

            layer_Sedes_comunitarias_4.clearLayers();

            var filteredJson = {
                type: "FeatureCollection",
                features: json_Sedes_comunitarias_4.features.filter(function (feature) {
                    var matchTipo = (tipo === 'all' || feature.properties.Tipo === tipo);
                    var matchEstado = (estado === 'all' || feature.properties.Estado === estado);
                    return matchTipo && matchEstado;
                })
            };

            layer_Sedes_comunitarias_4.addData(filteredJson);
            updateKPIs(tipo, estado);
            updateCharts(filteredJson.features);
        }

        function updateKPIs(tipo, estado) {
            var filtered = json_Sedes_comunitarias_4.features.filter(function (f) {
                var matchTipo = (tipo === 'all' || f.properties.Tipo === tipo);
                var matchEstado = (estado === 'all' || f.properties.Estado === estado);
                return matchTipo && matchEstado;
            });

            var totalInv = filtered.reduce((acc, f) => acc + (f.properties.Monto || 0), 0);
            var totalBenef = filtered.reduce((acc, f) => acc + (f.properties.Beneficiarios || 0), 0);
            var avgAvance = filtered.length > 0 ? (filtered.reduce((acc, f) => acc + (f.properties.Ejecucion || 0), 0) / filtered.length).toFixed(0) : 0;

            document.getElementById('kpi-total-proyectos').innerText = filtered.length;
            document.getElementById('kpi-inversion-total').innerText = '$' + (totalInv / 1000000).toFixed(1) + 'M';
            document.getElementById('kpi-beneficiarios').innerText = totalBenef.toLocaleString();
            document.getElementById('kpi-avance').innerText = avgAvance + '%';

            if (chartTipo) updateCharts(filtered);
        }

        // Chart instances
        var chartTipo, chartEstado;

        function initCharts() {
            var ctxTipo = document.getElementById('chart-tipo').getContext('2d');
            chartTipo = new Chart(ctxTipo, {
                type: 'doughnut',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: ['#38bdf8', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: '#94a3b8', font: { size: 10, family: 'Outfit' }, boxWidth: 10 }
                        }
                    },
                    cutout: '70%'
                }
            });

            var ctxEstado = document.getElementById('chart-estado').getContext('2d');
            chartEstado = new Chart(ctxEstado, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Proyectos',
                        data: [],
                        backgroundColor: '#38bdf8',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { color: '#94a3b8', stepSize: 1 },
                            grid: { color: 'rgba(255,255,255,0.05)' }
                        },
                        x: {
                            ticks: { color: '#94a3b8', font: { size: 9 } },
                            grid: { display: false }
                        }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function updateCharts(filteredData) {
            if (!chartTipo || !chartEstado) return;

            // Data for Tipo
            var tipos = {};
            filteredData.forEach(f => {
                var t = f.properties.Tipo;
                tipos[t] = (tipos[t] || 0) + (f.properties.Monto || 0);
            });
            chartTipo.data.labels = Object.keys(tipos);
            chartTipo.data.datasets[0].data = Object.values(tipos).map(v => v / 1000000);
            chartTipo.update();

            // Data for Estado
            var estados = { 'Pendiente': 0, 'En Ejecuci√≥n': 0, 'Finalizado': 0, 'Auditado': 0 };
            filteredData.forEach(f => {
                var est = f.properties.Estado;
                if (estados.hasOwnProperty(est)) estados[est]++;
            });
            chartEstado.data.labels = Object.keys(estados);
            chartEstado.data.datasets[0].data = Object.values(estados);
            chartEstado.update();
        }

        setBounds();
        initCharts();
        updateKPIs('all', 'all');
    </script>
</body>

</html>